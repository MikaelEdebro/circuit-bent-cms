@model IEnumerable<BandPage.Models.Image>

@{
    ViewBag.Title = "Image gallery";
}

<h1>Image gallery</h1>

@using (Html.BeginForm("ImageGalleryOnMenu", "ImageGallery"))
{
    <div class="form-row">
        <span>Image gallery name (will appear on menu):</span>
        <input type="text" name="ImageGalleryName" id="ImageGalleryName" class="textboxSmall" value="@ViewBag.ImageGalleryName" />
        <input type="submit" value="Save" />
    </div>
    
}

<div id="fine-uploader" style="clear: both">      
    <noscript>          
	    <p>You need JavaScript activated to upload images.</p>
    </noscript>         
</div>

<ul id="image-gallery">
@foreach (var item in Model) {
    <li>
        <img src="~/Images/ImageGallery/@item.ImageUrl" alt="" data-filename="@item.ImageUrl" class="image-gallery-thumb" />
        <div class="delete">
            <img src="~/Images/icon-delete.gif" alt="Delete" title="Delete image" />
        </div>
    </li>    
}
</ul>

<!-- FineUploader -->
<link href="~/Scripts/fineuploader/fineuploader.css" rel="stylesheet" type="text/css" />
<script src="~/Scripts/fineuploader/jquery.fineuploader-3.0.js" type="text/javascript"></script>


<script>
    $(function () {
        // apply the event handlers
        addHandlers();
    });


    // adds the event handlers to the images
    function addHandlers() {
        $('#image-gallery li').mouseenter(function () {
            // show the thrashcan icon
            $(this).find('.delete').show();

            // remove the image that is clicked on
            $(this).find('.delete').click(function () {
                // run deleteImage and pass along the filename that we get from det data-filename attribute
                deleteImage($(this).parent().find('img').attr('data-filename'));
            });
        });

        // hide the thrashcan icon
        $('#image-gallery li').mouseleave(function () {
            $(this).find('.delete').hide();
        });
    }

    

    // runs an ajax call and deletes the image
    // also removes it from the DOM
    function deleteImage(fileName) {
        //console.log(fileName);

        // hide all delete icons
        $('.delete').hide();

        $.ajax({
            url: '/Admin/ImageGallery/DeleteImage',
            type: 'POST',
            data: { fileName: fileName }
        }).done(function () {
            // remove the parent li from the DOM
            $('img[data-filename="' + fileName + '"]').parent().remove();
        });
    }

    // start fineuploader code
    $('#fine-uploader').fineUploader({
        request: {
            endpoint: '/ImageGallery/FileUpload'
        },
        validation: {
            allowedExtensions: ['jpeg', 'jpg', 'gif', 'png'],
            acceptFiles: 'image/gif, image/jpeg, image/png',
            sizeLimit: 4097024 // 4mb (calculation: 50 kB = 50 * 1024 bytes)
        },
        text: {
            uploadButton: 'Click to upload image',
            cancelButton: 'Cancel',
            failUpload: 'Error',
            formatProgress: 'Upload in progress...'
        },
        failedUploadTextDisplay: {
            mode: 'custom',
            maxChars: 40,
            responseProperty: 'error',
            enableTooltip: true
        },
        debug: true,
        multiple: false,
        maxConnections: 1
    }).on('complete', function (event, id, fileName, responseJSON) {
        // if the image was uploaded successfully
        if (responseJSON.success) {

            // show thumbnail, use the alt attribute to send information to the ajax function
            var el = $('<li><img src="/Images/ImageGallery/' + responseJSON.newFileName + '" alt="" data-filename="' + responseJSON.newFileName + '" class="image-gallery-thumb"><div class="delete"><img src="/Images/icon-delete.gif" alt="Delete" title="Delete image" /></div></li>');
            $('#image-gallery').prepend(el);

            // add the handlers after the element have been prepended to the list
            addHandlers();

        }
    });
</script>